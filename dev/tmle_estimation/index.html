<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Targeted Minimum Loss Based Estimation · TargetedEstimation.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://TARGENE.github.io/TargetedEstimation.jl/tmle_estimation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="TargetedEstimation.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">TargetedEstimation.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Command Line Interfaces</span><ul><li><a class="tocitem" href="../environment/">The Run Environment</a></li><li class="is-active"><a class="tocitem" href>Targeted Minimum Loss Based Estimation</a><ul class="internal"><li><a class="tocitem" href="#Usage"><span>Usage</span></a></li><li><a class="tocitem" href="#Output-file"><span>Output file</span></a></li><li><a class="tocitem" href="#Estimator-File"><span>Estimator File</span></a></li><li><a class="tocitem" href="#Runtime"><span>Runtime</span></a></li></ul></li><li><a class="tocitem" href="../sieve_variance/">Sieve Variance Plateau Estimation</a></li><li><a class="tocitem" href="../merge/">Merging TMLE and SVP outputs</a></li></ul></li><li><span class="tocitem">MLJ Extensions</span><ul><li><a class="tocitem" href="../models/">Models</a></li><li><a class="tocitem" href="../resampling/">Resampling Strategies</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Command Line Interfaces</a></li><li class="is-active"><a href>Targeted Minimum Loss Based Estimation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Targeted Minimum Loss Based Estimation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/TARGENE/TargetedEstimation.jl/blob/main/docs/src/tmle_estimation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Targeted-Minimum-Loss-Based-Estimation"><a class="docs-heading-anchor" href="#Targeted-Minimum-Loss-Based-Estimation">Targeted Minimum Loss Based Estimation</a><a id="Targeted-Minimum-Loss-Based-Estimation-1"></a><a class="docs-heading-anchor-permalink" href="#Targeted-Minimum-Loss-Based-Estimation" title="Permalink"></a></h1><p>This is the main script in this package, it provides a command line interface for the estimation of statistical parameters using targeted Learning.</p><h2 id="Usage"><a class="docs-heading-anchor" href="#Usage">Usage</a><a id="Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Usage" title="Permalink"></a></h2><p>Provided you have the package and all dependencies installed or in the provided docker container, you can run TMLE via the following command:</p><pre><code class="language-bash hljs">julia scripts/tmle.jl DATAFILE PARAMFILE OUTFILE
        --estimator-file=docs/estimators/glmnet.jl
        --hdf5-out=output.hdf5
        --pval-threshold=0.05
        --chunksize=100
        --verbosity=1</code></pre><p>where:</p><ul><li><code>DATAFILE</code>: A CSV (.csv) or Arrow (.arrow) file containing the tabular data. The format will be infered from the extension.</li><li><code>PARAMFILE</code>: A serialized <a href="https://targene.github.io/TMLE.jl/stable/user_guide/#Reading-Parameters-from-YAML-files">YAML</a> or <a href="https://docs.julialang.org/en/v1/stdlib/Serialization/">bin</a> file containing the estimands to be estimated. The YAML file can be written by hand or programmatically using the <a href="https://targene.github.io/TMLE.jl/stable/api/#TMLE.parameters_to_yaml-Tuple{Any,%20Any}">TMLE.parameters<em>to</em>yaml</a> function.</li><li><code>OUTFILE</code>: The output .csv file (see <a href="#Output-file">Output file</a>)</li><li><code>--estimator-file</code>: A Julia file describing the TMLE specifications (see <a href="#Estimator-File">Estimator File</a>).</li><li><code>--hdf5-out</code>: if provided, a path to a file to save the influence curves.</li><li><code>--pval-threshold</code>: Only &quot;significant&quot; (&lt; this threshold) estimates will actually have their influence curves stored in the previous file.</li><li><code>--chunksize</code>: To manage memory, the results are appended to the output files in batches the size of which can be controlled via this option.</li><li><code>--verbosity</code>: The verbosity level.</li></ul><h2 id="Output-file"><a class="docs-heading-anchor" href="#Output-file">Output file</a><a id="Output-file-1"></a><a class="docs-heading-anchor-permalink" href="#Output-file" title="Permalink"></a></h2><p>The output file is a plain CSV file containing one line per estimand in the input <code>PARAMFILE</code>. The file contains the following columns:</p><ul><li><code>PARAMETER_TYPE</code>: The estimand type (e.g. &quot;ATE&quot;, &quot;IATE&quot;, ...).</li><li><code>TREATMENTS</code>: A &quot;<em>&amp;</em>&quot; separated string containing all treatment variables associated with the estimand.</li><li><code>CASE</code>: A &quot;<em>&amp;</em>&quot; separated string containing the treatment variables&#39; case values in the same order as <code>TREATMENTS</code>.</li><li><code>CONTROL</code>: A &quot;<em>&amp;</em>&quot; separated string containing the treatment variables&#39; control values in the same order as <code>TREATMENTS</code>.</li><li><code>TARGET</code>: The outcome variable.</li><li><code>CONFOUNDERS</code>: A &quot;<em>&amp;</em>&quot; separated string containing the confounding variables.</li><li><code>COVARIATES</code>: A &quot;<em>&amp;</em>&quot; separated string containing the extra covariates used to estimate the outcome&#39;s mean.</li><li><code>INITIAL_ESTIMATE</code>: The initial estimate before the targeting step.</li><li><code>TMLE_ESTIMATE</code>: The targeted estimate.</li><li><code>TMLE_STD</code>: The standard deviation associated with the targeted estimate.</li><li><code>TMLE_PVALUE</code>: The p-value associated with the targeted estimate.</li><li><code>TMLE_LWB</code>: The 95% confidence interval lower bound associated with the targeted estimate.</li><li><code>TMLE_UPB</code>: The 95% confidence interval upper bound associated with the targeted estimate.</li><li><code>ONESTEP_ESTIMATE</code>: The one step estimate.</li><li><code>ONESTEP_STD</code>: The standard deviation associated with the one step estimate.</li><li><code>ONESTEP_PVALUE</code>: The p-value associated with the one step estimate.</li><li><code>ONESTEP_LWB</code>: The 95% confidence interval lower bound associated with the one step estimate.</li><li><code>ONESTEP_UPB</code>: The 95% confidence interval upper bound associated with the one step estimate.</li><li><code>LOG</code>: A log message if estimation failed.</li></ul><h2 id="Estimator-File"><a class="docs-heading-anchor" href="#Estimator-File">Estimator File</a><a id="Estimator-File-1"></a><a class="docs-heading-anchor-permalink" href="#Estimator-File" title="Permalink"></a></h2><p>TMLE is an adaptive procedure that depends on the specification of learning algorithms for the estimation of the nuisance parameters (see <a href="https://targene.github.io/TMLE.jl/stable/">TMLE.jl</a> for a description of the assumed setting). In our case, there are two nuisance parameters for which we need to specify learning algorithms:</p><ul><li><code>E[Y|T, W, C]</code>: The mean outcome given the treatment, confounders and extra covariates. It is commonly denoted by <code>Q</code> in the Targeted Learning litterature.</li><li><code>p(T|W)</code>: The propensity score. It is commonly denoted by <code>G</code> in the Targeted Learning litterature.</li></ul><h3 id="Description-of-the-file"><a class="docs-heading-anchor" href="#Description-of-the-file">Description of the file</a><a id="Description-of-the-file-1"></a><a class="docs-heading-anchor-permalink" href="#Description-of-the-file" title="Permalink"></a></h3><p>In order to provide maximum flexibility as to the choice of learning algorithms, the estimator file is a plain <a href="https://julialang.org/">Julia</a> file. This file is optional and omitting it defaults to using generalized linear models. If provided, it must define a <a href="https://docs.julialang.org/en/v1/base/base/#Core.NamedTuple">NamedTuple</a> called <code>tmle_spec</code> containing any of the following fields as follows (default configuration):</p><pre><code class="language-julia hljs">
tmle_spec = (
  Q_continuous = LinearRegressor(),
  Q_binary     = LogisticClassifier(lambda=0.),
  G            = LogisticClassifier(lambda=0.),
  threshold    = 1e-8,
  cache        = false,
  weighted_fluctuation = false
)</code></pre><p>where:</p><ul><li><code>Q_continuous</code>: is a MLJ model used for the estimation of <code>E[Y|T, W, C]</code> when the outcome <code>Y</code> is continuous.</li><li><code>Q_binary</code>: is a MLJ model used for the estimation of <code>E[Y|T, W, C]</code> when the outcome <code>Y</code> is binary.</li><li><code>G</code>: is a MLJ model used for the estimation of <code>p(T|W)</code>.</li><li><code>threshold</code>: is the minimum value the propensity score <code>G</code> is allowed to take.</li><li><code>cache</code>: controls caching of data by <a href="https://alan-turing-institute.github.io/MLJ.jl/dev/machines/">MLJ machines</a>. Setting it to <code>true</code> may result in faster runtime but higher memory usage.</li><li><code>weighted_fluctuation</code>: controls whether the fluctuation for <code>Q</code> is a weighted glm or not. If some of the treatment values are rare it may lead to more robust estimation.</li></ul><p>Typically, <code>Q_continuous</code>, <code>Q_binary</code> and <code>G</code> will be adjusted and other fields can be left unspecified.</p><h3 id="Ready-to-use-estimator-files"><a class="docs-heading-anchor" href="#Ready-to-use-estimator-files">Ready to use estimator files</a><a id="Ready-to-use-estimator-files-1"></a><a class="docs-heading-anchor-permalink" href="#Ready-to-use-estimator-files" title="Permalink"></a></h3><p>We recognize not everyone will be familiar with <a href="https://julialang.org/">Julia</a>. We thus provide a set of ready to use estimator files that can be simplified or extended as needed:</p><ul><li>Super Learning: <a href="../estimators/superlearning-with-interactions-for-Q.jl">with</a> and <a href="../estimators/superlearning.jl">without</a> interaction terms in the GLM models for Q.</li><li>Super Learning for G and GLMNet for Q: <a href="../estimators/G-superlearning-Q-glmnet.jl">here</a>.</li><li>Super Learning for G and GLM for Q: <a href="../estimators/G-superlearning-Q-glm.jl">here</a>.</li><li>GLMNet: <a href="../estimators/glmnet-with-interactions-for-Q.jl">with</a> and <a href="../estimators/glmnet.jl">without</a> interaction terms in the GLM models for Q.</li><li>GLM: <a href="../estimators/glm-with-interactions-for-Q.jl">with</a> and <a href="../estimators/glm.jl">without</a> interaction terms in the GLM models for Q.</li><li>XGBoost: <a href="../estimators/tuned-xgboost.jl">with tuning</a>.</li></ul><h2 id="Runtime"><a class="docs-heading-anchor" href="#Runtime">Runtime</a><a id="Runtime-1"></a><a class="docs-heading-anchor-permalink" href="#Runtime" title="Permalink"></a></h2><p>Targeted Learning can quickly become computationally intensive compared to traditional parametric inference. Here, we illustrate typical runtimes using examples from population genetics. This is because population genetics is currently the main use case for this package, but it shouldn&#39;t be understood as the only scope. In fact, the two most prominent study designs in population genetics are perfect illustrations of the computational complexity associated with Targeted Learning.</p><h3 id="Preliminary"><a class="docs-heading-anchor" href="#Preliminary">Preliminary</a><a id="Preliminary-1"></a><a class="docs-heading-anchor-permalink" href="#Preliminary" title="Permalink"></a></h3><p>Remember that for each estimand of interest, Targeted Learning requires 3 main ingredients that drive computational complexity:</p><ul><li>An estimator for the propensity score: <code>G(T, W) = P(T|W)</code>.</li><li>An estimator for the outcome&#39;s mean: <code>Q(T, W) = E[Y|T, W]</code>.</li><li>A targeting step towards the estimand of interest.</li></ul><p>While the targeting step has a fixed form, both <code>G</code> and <code>Q</code> require specification of learning algorithms that can range from simple generalized linear models to complex Super Learners. In general, one doesn&#39;t know how the data has been generated and the model space should be kept as large as possible in order to provide valid inference. This means we recommend the use Super Learning for both <code>G</code> and <code>Q</code> as it comes with asymptotic theoretical guarantees. However, Super Learning is an expensive procedure and, depending on the context, might become infeasible. Also, notice that while the targeting step is specific to a given estimand, <code>G</code> and <code>Q</code> are only specific to the variables occuring in the causal graph. This means that they can potentially be cleverly reused across the estimation of multiple estimands. Note that this clever reuse, is already baked into this package, and nothing needs to be done beside specifying the learning algorithms for <code>G</code> and <code>Q</code>. The goal of the subsequent sections is to provide some examples, guiding the choice of those learning algorithms.</p><p>In what follows, <code>Y</code> is an outcome of interest, <code>W</code> a set of confounding variables and <code>T</code> a genetic variation. Genetic variations are usually represented as a pair of alleles corresponding to an individual&#39;s genotype. We will further restrict the scope to bi-allelic single nucleotide variations. This means that, at a given locus where the two alleles are <code>A</code> and <code>C</code>, an individual could have any of the following genotype: <code>AA</code>, <code>AC</code>, <code>CC</code>. Those will be our treatment values.</p><p>For all the following experiments:</p><ul><li>The Julia script can be found at <a href="../../../experiments/runtime.jl">experiments/runtime.jl</a>.</li><li>The various estimators used below are further described in <a href="#Ready-to-use-estimator-files">Ready to use estimator files</a>.</li></ul><h3 id="Multiple-treatment-contrasts"><a class="docs-heading-anchor" href="#Multiple-treatment-contrasts">Multiple treatment contrasts</a><a id="Multiple-treatment-contrasts-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-treatment-contrasts" title="Permalink"></a></h3><p>In a classic randomized control trial, the treatment variable can only take one of two levels: <code>treated</code> or <code>not treated</code>. In out example however, any genetic variation takes its values from three different levels. As such, the <code>treated</code> and <code>not treated</code> levels need to be defined and any of the following contrasts can be of interest:</p><ul><li><code>AA</code> -&gt; <code>AC</code></li><li><code>AC</code> -&gt; <code>CC</code></li><li><code>AA</code> -&gt; <code>CC</code></li></ul><p>For a given outcome and genetic variation, for each contrast, both <code>G</code> and <code>Q</code> are actually invariant. This shows a first level of reduction in computational complexity. <strong>Both <code>G</code> and <code>Q</code> need to be fitted only once across multiple treatment contrasts and only the targeting step needs to be carried out again.</strong></p><h3 id="The-PheWAS-study-design"><a class="docs-heading-anchor" href="#The-PheWAS-study-design">The PheWAS study design</a><a id="The-PheWAS-study-design-1"></a><a class="docs-heading-anchor-permalink" href="#The-PheWAS-study-design" title="Permalink"></a></h3><p>In a PheWAS, one is interested in the effect of a genetic variation across many outcomes (typically around 1000). Because the treatment variable is always the same, the propensity score <code>G</code> can be reused across all parameters, which drastically reduces computational complexity.</p><div style="text-align:center">
<img src="assets/phewas.png" alt="PheWAS" style="width:400px;"/>
</div><p>With this setup in mind, the computational complexity is mostly driven by the specification of the learning algorithms for <code>Q</code>, which will have to be fitted for each outcome. For 10 outcomes, we estimate the 3 Average Treatment Effects corresponding to the 3 possible treatment contrasts defined in the previous section. There are thus two levels of reuse of <code>G</code> and <code>Q</code> in this study design. In the table below are presented some runtimes for various specifications of <code>G</code> and <code>Q</code> using a single cpu. The &quot;Unit runtime&quot; is the average runtime across all estimands and can roughly be extrapolated to bigger studies.</p><table><tr><th style="text-align: right">Estimator file</th><th style="text-align: center">Unit runtime (s)</th><th style="text-align: center">Extrapolated runtime to 1000 outcomes</th></tr><tr><td style="text-align: right"><code>docs/src/estimators/glm.jl</code></td><td style="text-align: center">4.65</td><td style="text-align: center">≈ 1h20</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/glmnet.jl</code></td><td style="text-align: center">7.19</td><td style="text-align: center">≈ 2h</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/G-superlearning-Q-glmnet.jl</code></td><td style="text-align: center">50.05</td><td style="text-align: center">≈ 13h45</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/superlearning.jl</code></td><td style="text-align: center">168.98</td><td style="text-align: center">≈ 46h</td></tr></table><p>Depending on the exact setup, this means one can probably afford to use Super Learning for at least the estimation of <code>G</code> (and potentially also for <code>Q</code> for a single PheWAS). This turns out to be a great news because TMLE is a double robust estimator. As a reminder, it means that only one of the estimators for <code>G</code> or <code>Q</code> needs to converge sufficiently fast to the ground truth to guarantee that our estimates will be asymptotically unbiased.</p><p>Finally, note that those runtime estimates should be interpreted as worse cases, this is because:</p><ul><li>Only 1 cpu is used.</li><li>Most modern high performance computing platform will allow further parallelization.</li><li>In the case where <code>G</code> only is a Super Learner, since the number of parameters is still relatively low in this example, it is possible that the time to fit <code>G</code> still dominates the runtime.</li><li>Runtimes include precompilation which becomes negligible with the size of the study.</li></ul><h3 id="The-GWAS-study-design"><a class="docs-heading-anchor" href="#The-GWAS-study-design">The GWAS study design</a><a id="The-GWAS-study-design-1"></a><a class="docs-heading-anchor-permalink" href="#The-GWAS-study-design" title="Permalink"></a></h3><p>In a GWAS, the outcome variable is held fixed and we are interested in the effects of very many genetic variations on this outcome (typically 800 000 for a genotyping array). The propensity score cannot be reused across parameters resulting in a more expensive run.</p><div style="text-align:center">
<img src="assets/gwas.png" alt="GWAS" style="width:400px;"/>
</div><p>Again, we estimate the 3 Average Treatment Effects corresponding to the 3 possible treatment contrasts. However we now look at 3 different genetic variations and only one outcome. In the table below are presented some runtimes for various specifications of <code>G</code> and <code>Q</code> using a single cpu. The &quot;Unit runtime&quot; is the average runtime across all estimands and can roughly be extrapolated to bigger studies.</p><table><tr><th style="text-align: right">Estimator file</th><th style="text-align: center">Continuous outcome unit runtime (s)</th><th style="text-align: center">Binary outcome unit runtime (s)</th><th style="text-align: center">Projected Time on HPC (200 folds //)</th></tr><tr><td style="text-align: right"><code>docs/src/estimators/glm.jl</code></td><td style="text-align: center">5.64</td><td style="text-align: center">6.14</td><td style="text-align: center">≈ 6h30</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/glmnet.jl</code></td><td style="text-align: center">17.46</td><td style="text-align: center">22.24</td><td style="text-align: center">≈ 22h</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/G-superlearning-Q-glmnet.jl</code></td><td style="text-align: center">430.54</td><td style="text-align: center">438.67</td><td style="text-align: center">≈ 20 days</td></tr><tr><td style="text-align: right"><code>docs/src/estimators/superlearning.jl</code></td><td style="text-align: center">511.26</td><td style="text-align: center">567.72</td><td style="text-align: center">≈ 24 days</td></tr></table><p>We can see that modern high performance computing platforms definitely enable this study design when using GLMs or GLMNets. It is unlikely however, that you will be able to use Super Learning for any of <code>P(V|W)</code> or <code>E[Y|V, W]</code> if you don&#39;t have privileged access to such platform. While the double robustness guarantees will generally not be satisfied, our estimate will still be targeted, which means that its bias will be reduced compared to classic inference using a parametric model.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../environment/">« The Run Environment</a><a class="docs-footer-nextpage" href="../sieve_variance/">Sieve Variance Plateau Estimation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 21 July 2023 12:36">Friday 21 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
